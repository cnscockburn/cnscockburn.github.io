---
interface TocHeading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: TocHeading[];
}

const { headings } = Astro.props;

// Include h2, h3, and h4 headings to cover all common blog post structures
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 4);
---

{
  tocHeadings.length > 2 && (
    <nav
      id="table-of-contents"
      class="mb-10 rounded-xl border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 overflow-hidden"
      aria-label="Table of Contents"
    >
      <button
        id="toc-toggle"
        type="button"
        class="w-full flex items-center justify-between px-5 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer"
        aria-expanded="false"
        aria-controls="toc-list"
      >
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6" />
            <line x1="8" y1="12" x2="21" y2="12" />
            <line x1="8" y1="18" x2="21" y2="18" />
            <line x1="3" y1="6" x2="3.01" y2="6" />
            <line x1="3" y1="12" x2="3.01" y2="12" />
            <line x1="3" y1="18" x2="3.01" y2="18" />
          </svg>
          Table of Contents
        </span>
        <svg
          id="toc-chevron"
          class="w-4 h-4 transition-transform duration-200"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      <ul
        id="toc-list"
        class="hidden border-t border-gray-200 dark:border-gray-800 px-5 py-3 space-y-1"
      >
        {tocHeadings.map((heading) => {
          const indent = heading.depth === 2 ? "" : heading.depth === 3 ? "pl-4" : "pl-8";
          const style = heading.depth === 2
            ? "text-gray-600 dark:text-gray-400 font-medium"
            : "text-gray-500 dark:text-gray-500";
          return (
            <li>
              <a
                href={`#${heading.slug}`}
                class={`toc-link block py-1 text-sm transition-colors duration-200 hover:text-gray-900 dark:hover:text-gray-100 ${indent} ${style}`}
                data-heading={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          );
        })}
      </ul>
    </nav>
  )
}

<script is:inline>
  (function() {
    function initToc() {
      var toggle = document.getElementById("toc-toggle");
      var list = document.getElementById("toc-list");
      var chevron = document.getElementById("toc-chevron");

      if (!toggle || !list) return;

      // Remove old listener if it exists (for View Transitions)
      if (toggle._tocHandler) {
        toggle.removeEventListener("click", toggle._tocHandler);
      }

      toggle._tocHandler = function() {
        var isExpanded = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", String(!isExpanded));
        list.classList.toggle("hidden");
        if (chevron) chevron.classList.toggle("rotate-180");
      };

      toggle.addEventListener("click", toggle._tocHandler);

      // Active heading highlighting
      var tocLinks = document.querySelectorAll(".toc-link");
      if (tocLinks.length === 0) return;

      var headingElements = [];
      for (var i = 0; i < tocLinks.length; i++) {
        var id = tocLinks[i].getAttribute("data-heading");
        var el = id ? document.getElementById(id) : null;
        if (el) headingElements.push(el);
      }

      function updateActive() {
        var current = "";
        for (var i = 0; i < headingElements.length; i++) {
          var rect = headingElements[i].getBoundingClientRect();
          if (rect.top <= 120) {
            current = headingElements[i].id;
          }
        }
        for (var j = 0; j < tocLinks.length; j++) {
          var isActive = tocLinks[j].getAttribute("data-heading") === current;
          if (isActive) {
            tocLinks[j].style.color = "";
            tocLinks[j].style.fontWeight = "700";
            tocLinks[j].classList.add("!text-gray-900", "dark:!text-gray-100");
          } else {
            tocLinks[j].style.fontWeight = "";
            tocLinks[j].classList.remove("!text-gray-900", "dark:!text-gray-100");
          }
        }
      }

      if (window._tocScrollHandler) {
        window.removeEventListener("scroll", window._tocScrollHandler);
      }
      window._tocScrollHandler = updateActive;
      window.addEventListener("scroll", updateActive, { passive: true });
      updateActive();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initToc);
    } else {
      initToc();
    }
    document.addEventListener("astro:page-load", initToc);
  })();
</script>
