---
import { siteConfig } from "../config";
---

<div
  id="reading-progress-container"
  class="fixed top-0 left-0 right-0 z-[60] h-[3px] pointer-events-none"
  style="display: none;"
>
  <div
    id="reading-progress-bar"
    class="h-full w-0"
    style={`background-color: ${siteConfig.accentColor}`}
  />
</div>

<script is:inline>
  (function() {
    function initReadingProgress() {
      const bar = document.getElementById("reading-progress-bar");
      const container = document.getElementById("reading-progress-container");
      if (!bar || !container) return;

      const article = document.querySelector("article");
      if (!article) {
        container.style.display = "none";
        return;
      }
      container.style.display = "";

      function updateProgress() {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        if (docHeight <= 0) return;
        const progress = Math.min((scrollTop / docHeight) * 100, 100);
        bar.style.width = progress + "%";
      }

      // Remove any previously attached listener
      if (window._readingProgressHandler) {
        window.removeEventListener("scroll", window._readingProgressHandler);
      }
      window._readingProgressHandler = updateProgress;
      window.addEventListener("scroll", updateProgress, { passive: true });
      updateProgress();
    }

    // Run on initial load and after View Transition navigation
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initReadingProgress);
    } else {
      initReadingProgress();
    }
    document.addEventListener("astro:page-load", initReadingProgress);
  })();
</script>
