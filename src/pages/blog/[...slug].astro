---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import ReadingProgress from "../../components/ReadingProgress.astro";
import SeriesBanner from "../../components/SeriesBanner.astro";
import { getCollection, render } from "astro:content";
import { siteConfig } from "../../config";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const sorted = posts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );
  
  return sorted.map((post, index) => {
    const relatedPosts = sorted
      .filter((p) => p.id !== post.id)
      .filter((p) =>
        p.data.tags.some((tag) => post.data.tags.includes(tag))
      )
      .sort((a, b) => {
        const aTags = a.data.tags.filter((t) => post.data.tags.includes(t)).length;
        const bTags = b.data.tags.filter((t) => post.data.tags.includes(t)).length;
        return bTags - aTags || b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
      })
      .slice(0, 3);

    // Compute series posts if this post belongs to a series
    const seriesPosts = post.data.series
      ? sorted
          .filter((p) => p.data.series === post.data.series)
          .map((p) => ({
            id: p.id,
            title: p.data.title,
            order: p.data.seriesOrder ?? 0,
          }))
      : [];

    return {
      params: { slug: post.id },
      props: {
        post,
        prevPost: index > 0 ? sorted[index - 1] : null,
        nextPost: index < sorted.length - 1 ? sorted[index + 1] : null,
        relatedPosts,
        seriesPosts,
      },
    };
  });
}

const { post, prevPost, nextPost, relatedPosts, seriesPosts } = Astro.props;
const { Content, headings } = await render(post);

// Reading time calculation (body may not be available in all Astro versions)
const bodyText = (post as any).body || "";
const words = bodyText.split(/\s+/).filter(Boolean).length;
const readingTime = Math.max(1, Math.ceil(words / 200));
---

<BaseLayout title={post.data.title} description={post.data.description} image={post.data.image}>
  <ReadingProgress />
  <!-- JSON-LD Schema (Article) -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "author": {
      "@type": "Person",
      "name": siteConfig.name,
      "url": "https://cnscockburn.github.io"
    },
    "datePublished": post.data.pubDate.toISOString(),
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://cnscockburn.github.io/blog/${post.id}/`
    }
  })} />

  <div class="pt-24 sm:pt-32 pb-16 px-4 sm:px-12 md:px-16 lg:px-24">
    <div class="max-w-3xl mx-auto">
      <!-- Breadcrumbs -->
      <Breadcrumbs
        items={[
          { label: "Blog", href: "/blog/" },
          { label: post.data.title, href: Astro.url.pathname },
        ]}
        className="mb-8"
      />

      <!-- Post Header -->
      <header class="mb-10">
        <div
          class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-4"
        >
          <time datetime={post.data.pubDate.toISOString()}>
            {
              post.data.pubDate.toLocaleDateString("en-GB", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          <span>·</span>
          <span>{readingTime} min read</span>
          {
            post.data.draft && (
              <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded text-xs font-medium">
                Draft
              </span>
            )
          }
        </div>

        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 leading-tight"
        >
          {post.data.title}
        </h1>

        {
          post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-6">
              {post.data.tags.map((tag: string) => (
                <a
                  href={`/blog/?tag=${encodeURIComponent(tag)}`}
                  class="px-3 py-1 bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200"
                >
                  {tag}
                </a>
              ))}
            </div>
          )
        }
        {/* Cover Image */}
        {
          post.data.image && (
            <img
              src={post.data.image}
              alt={post.data.title}
              class="w-full rounded-xl mt-8 shadow-lg"
              loading="eager"
            />
          )
        }
      </header>

      <!-- Table of Contents -->
      <TableOfContents headings={headings} />

      <!-- Series Banner -->
      {
        post.data.series && seriesPosts.length > 1 && (
          <SeriesBanner
            seriesName={post.data.series}
            seriesPosts={seriesPosts}
            currentPostId={post.id}
          />
        )
      }

      <!-- Post Content -->
      <article
        class="prose prose-lg dark:prose-invert prose-gray max-w-none
          prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-gray-100
          prose-a:font-medium prose-a:no-underline hover:prose-a:underline
          prose-code:text-sm prose-code:font-normal
          prose-pre:bg-gray-50 dark:prose-pre:bg-gray-900 prose-pre:border prose-pre:border-gray-200 dark:prose-pre:border-gray-800
          prose-img:rounded-xl
          prose-blockquote:border-l-4 prose-blockquote:not-italic"
        style={`--tw-prose-links: ${siteConfig.accentColor}; --tw-prose-quote-borders: ${siteConfig.accentColor};`}
      >
        <Content />
      </article>

      <!-- Prev / Next Navigation -->
      {
        (prevPost || nextPost) && (
          <nav class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {prevPost ? (
                <a
                  href={`/blog/${prevPost.id}/`}
                  class="group flex flex-col p-4 rounded-xl border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 transition-all duration-200"
                >
                  <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                    ← Previous
                  </span>
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100 group-hover:text-[var(--accent)] transition-colors" style={`--accent: ${siteConfig.accentColor}`}>
                    {prevPost.data.title}
                  </span>
                </a>
              ) : (
                <div />
              )}
              {nextPost ? (
                <a
                  href={`/blog/${nextPost.id}/`}
                  class="group flex flex-col p-4 rounded-xl border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 transition-all duration-200 sm:text-right"
                >
                  <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                    Next →
                  </span>
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100 group-hover:text-[var(--accent)] transition-colors" style={`--accent: ${siteConfig.accentColor}`}>
                    {nextPost.data.title}
                  </span>
                </a>
              ) : (
                <div />
              )}
            </div>
          </nav>
        )
      }

      <!-- Related Posts -->
      {
        relatedPosts.length > 0 && (
          <div class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">
              You might also like
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {relatedPosts.map((related) => (
                <a
                  href={`/blog/${related.id}/`}
                  class="group flex flex-col h-full bg-gray-50 dark:bg-gray-900 rounded-xl p-5 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                >
                  <h3 class="font-bold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-[var(--accent)] transition-colors" style={`--accent: ${siteConfig.accentColor}`}>
                    {related.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-3">
                    {related.data.description}
                  </p>
                </a>
              ))}
            </div>
          </div>
        )
      }

      <!-- Comments (Giscus) -->
      <div class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Comments
        </h2>
        <script
          is:inline
          src="https://giscus.app/client.js"
          data-repo="cnscockburn/cnscockburn.github.io"
          data-repo-id="R_kgDORRAOlA"
          data-category="General"
          data-category-id="DIC_kwDORRAOlM4C2guR"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="en"
          crossorigin="anonymous"
          async
        ></script>
      </div>

      <!-- Back to Blog -->
      <div
        class="mt-16 text-center"
      >
        <a
          href="/blog/"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200"
        >
          ← View all posts
        </a>
      </div>
    </div>
  </div>
</BaseLayout>
