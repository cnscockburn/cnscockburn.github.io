---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";
import { siteConfig } from "../../config";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await render(post);

// Reading time calculation (body may not be available in all Astro versions)
const bodyText = (post as any).body || "";
const words = bodyText.split(/\s+/).filter(Boolean).length;
const readingTime = Math.max(1, Math.ceil(words / 200));
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <main class="pt-24 sm:pt-32 pb-16 px-6 sm:px-12 md:px-16 lg:px-24">
    <div class="max-w-3xl mx-auto">
      <!-- Back link -->
      <a
        href="/blog/"
        class="inline-flex items-center gap-2 text-sm font-medium transition-colors duration-200 mb-8 group"
        style={`color: ${siteConfig.accentColor}`}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="transition-transform duration-200 group-hover:-translate-x-1"
        >
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        Back to Blog
      </a>

      <!-- Post Header -->
      <header class="mb-10">
        <div
          class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-4"
        >
          <time datetime={post.data.pubDate.toISOString()}>
            {
              post.data.pubDate.toLocaleDateString("en-GB", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          <span>·</span>
          <span>{readingTime} min read</span>
          {
            post.data.draft && (
              <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded text-xs font-medium">
                Draft
              </span>
            )
          }
        </div>

        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 leading-tight"
        >
          {post.data.title}
        </h1>

        {
          post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-6">
              {post.data.tags.map((tag: string) => (
                <a
                  href={`/blog/?tag=${encodeURIComponent(tag)}`}
                  class="px-3 py-1 bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200"
                >
                  {tag}
                </a>
              ))}
            </div>
          )
        }
      </header>

      <!-- Post Content -->
      <article
        class="prose prose-lg dark:prose-invert prose-gray max-w-none
          prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-gray-100
          prose-a:font-medium prose-a:no-underline hover:prose-a:underline
          prose-code:text-sm prose-code:font-normal
          prose-pre:bg-gray-50 dark:prose-pre:bg-gray-900 prose-pre:border prose-pre:border-gray-200 dark:prose-pre:border-gray-800
          prose-img:rounded-xl
          prose-blockquote:border-l-4 prose-blockquote:not-italic"
        style={`--tw-prose-links: ${siteConfig.accentColor}; --tw-prose-quote-borders: ${siteConfig.accentColor};`}
      >
        <Content />
      </article>

      <!-- Post Footer -->
      <div
        class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800 text-center"
      >
        <a
          href="/blog/"
          class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200"
        >
          ← View all posts
        </a>
      </div>
    </div>
  </main>
</BaseLayout>
